<template>
  <lightning-card>
    <template if:true={isLoading}>
      <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
    </template>
    <div class="slds-grid slds-grid_align-spread slds-wrap slds-var-m-horizontal_large">
      <div class="slds-var-m-top_medium">
        <h2 class="card-title">Search Log History</h2>
      </div>
      <div class="slds-var-m-right_medium">
        <lightning-button-icon
          icon-name="action:refresh"
          disabled={isLoading}
          variant="brand"
          onclick={handleRefresh}
          alternative-text="Refresh"
          title="Refresh"
          size="medium"
          tooltip="Refresh"
          class="refresh_buttom"
          icon-class="slds-m-around_large"
        >
        </lightning-button-icon>
      </div>
    </div>

    <template if:true={batchesToShow}>
      <template if:true={batchesToShow.length}>
        <div class="batches-content slds-var-m-horizontal_large">
          <table class="batches-table slds-table_cell-buffer slds-table_bordered slds-size_1-of-1">
            <thead>
              <tr>
                <th scope="col">Details</th>
                <th scope="col">Request ID</th>
                <th scope="col">License Number</th>
                <th scope="col">Status</th>
                <th scope="col">Added At</th>
              </tr>
            </thead>
            <tbody>
              <template for:each={batchesToShow} for:item="batch">
                <tr key={batch.Batch_Id__c}>
                  <td>
                    <lightning-button-icon
                      icon-class="expand-button"
                      icon-name={batch.iconName}
                      alternative-text="Expand Row"
                      title="Expand Row"
                      onclick={handleRowExpand}
                      data-id={batch.Batch_Id__c}
                      label="Expand Row"
                    >
                    </lightning-button-icon>
                  </td>
                  <td>{batch.Batch_Id__c}</td>
                  <td>{batch.licenseNumber}</td>
                  <td>{batch.Status__c}</td>
                  <td>{batch.Added_At__c}</td>
                </tr>
                <template if:true={batch.isExpanded}>
                  <tr key={batch.expandedKey}>
                    <td colspan="6">
                      <div class="expanded-content slds-grid slds-wrap slds-size_1-of-1">
                        <div class="slds-col slds-small-size_1-of-1 slds-large-size_1-of-2 slds-p-around_small">
                          <p><strong>Input Details:</strong></p>
                          <table class="slds-theme_default slds-table_cell-buffer slds-table_bordered slds-size_1-of-1">
                            <tbody>
                              <tr>
                                <td>License Number</td>
                                <td>{batch.formattedInput.licenseNumber}</td>
                              </tr>
                              <tr>
                                <td>State Code</td>
                                <td>{batch.formattedInput.stateCode}</td>
                              </tr>
                              <tr>
                                <td>Profession Code</td>
                                <td>{batch.formattedInput.professionCode}</td>
                              </tr>
                              <template if:true={batch.formattedInput.certState}>
                                <tr>
                                  <td>Cert State</td>
                                  <td>{batch.formattedInput.certState}</td>
                                </tr>
                              </template>
                              <template if:true={batch.formattedInput.firstName}>
                                <tr>
                                  <td>First Name</td>
                                  <td>{batch.formattedInput.firstName}</td>
                                </tr>
                              </template>
                              <template if:true={batch.formattedInput.middleName}>
                                <tr>
                                  <td>Middle Name</td>
                                  <td>{batch.formattedInput.middleName}</td>
                                </tr>
                              </template>
                              <template if:true={batch.formattedInput.lastName}>
                                <tr>
                                  <td>Last Name</td>
                                  <td>{batch.formattedInput.lastName}</td>
                                </tr>
                              </template>
                              <template if:true={batch.formattedInput.dateOfBirth}>
                                <tr>
                                  <td>Date Of Birth</td>
                                  <td>{batch.formattedInput.dateOfBirth}</td>
                                </tr>
                              </template>
                            </tbody>
                          </table>
                        </div>
                        <div class="slds-col slds-small-size_1-of-1 slds-large-size_1-of-2 slds-p-around_small">
                          <p><strong>Result Details:</strong></p>
                          <template if:true={batch.formattedResult.isFound}>
                            <table class="slds-theme_default slds-table_cell-buffer slds-table_bordered slds-size_1-of-1">
                              <tbody>
                                <template if:true={batch.formattedResult.firstName}>
                                  <tr>
                                    <td>First Name</td>
                                    <td>{batch.formattedResult.firstName}</td>
                                  </tr>
                                </template>
                                <template if:true={batch.formattedResult.middleName}>
                                  <tr>
                                    <td>Middle Name</td>
                                    <td>{batch.formattedResult.middleName}</td>
                                  </tr>
                                </template>
                                <template if:true={batch.formattedResult.lastName}>
                                  <tr>
                                    <td>Last Name</td>
                                    <td>{batch.formattedResult.lastName}</td>
                                  </tr>
                                </template>
                                <template if:true={batch.formattedResult.licenseStatus}>
                                  <tr>
                                    <td>License Status</td>
                                    <td>{batch.formattedResult.licenseStatus}</td>
                                  </tr>
                                </template>
                                <template if:true={batch.formattedResult.hasDisciplinaryActionAttribute}>
                                  <tr>
                                    <td>Disciplinary Action</td>
                                    <td>{batch.formattedResult.disciplinaryAction}</td>
                                  </tr>
                                </template>
                                <template if:true={batch.formattedResult.originalIssueDate}>
                                  <tr>
                                    <td>Original Issue Date</td>
                                    <td>{batch.formattedResult.originalIssueDate}</td>
                                  </tr>
                                </template>
                                <template if:true={batch.formattedResult.expirationDate}>
                                  <tr>
                                    <td>Expiration Date</td>
                                    <td>{batch.formattedResult.expirationDate}</td>
                                  </tr>
                                </template>
                              </tbody>
                            </table>
                          </template>
                          <template if:false={batch.formattedResult.isFound}>
                            <div class="slds-var-m-horizontal_large">
                              <p class="no-records-message">{batch.formattedResult.message}</p>
                            </div>
                          </template>
                        </div>
                      </div>
                    </td>
                  </tr>
                </template>
              </template>
            </tbody>
          </table>
        </div>
      </template>
      <template if:false={batchesToShow.length}>
        <template if:false={isLoading}>
          <div class="slds-var-m-horizontal_large">
            <p class="no-records-message">No records found</p>
          </div>
        </template>
      </template>
    </template>

    <template if:true={error}>
      <div
        class="slds-text-color_error slds-text-align_center slds-var-m-around_medium slds-var-m-top_large"
        role="alert"
      >
        <div>
          <p>
            <lightning-icon
              icon-name="utility:error"
              alternative-text="Error!"
              variant="error"
              title="Error!"
              size="x-small"
            >
            </lightning-icon>
            {error}
          </p>
        </div>
      </div>
    </template>
  </lightning-card>
</template>